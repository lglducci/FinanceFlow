{
  "name": "FinanceFLowSistema",
  "nodes": [
    {
      "parameters": {
        "jsCode": "return [{ json: { success: true, message: 'usuario ok' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1424,
        -592
      ],
      "id": "f2bb4f5f-7776-4870-8311-1d096f988712",
      "name": "Sim"
    },
    {
      "parameters": {
        "jsCode": "  return [{ json: { success: false, message: 'usuario invalido' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        -336
      ],
      "id": "9730909e-e47a-4c37-92a5-28381a5760bf",
      "name": "N√£o"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "usuarios",
        "filters": {
          "conditions": [
            {
              "keyName": "email",
              "keyValue": "={{$json.email}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2016,
        -480
      ],
      "id": "33664880-cbfd-43f2-b2a9-311157e44fad",
      "name": "DadosUsuario",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "GfCFzcpZSxkxWy1M",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n * \n  FROM usuario_empresa ue\nJOIN usuarios u ON u.id = ue.usuario_id \n  WHERE u.email= '{{ $('DadosUsuario').item.json.email }}' AND \n  u.senha_hash = '{{ $('DadosUsuario').item.json.senha_hash }}';\n ",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -848,
        -496
      ],
      "id": "c9a7e313-f1eb-4455-81ff-10485699f7c4",
      "name": "DadosEmpresa",
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "login",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2736,
        -480
      ],
      "id": "15f962f4-8c72-4bde-86fb-904d832ef237",
      "name": "Login",
      "webhookId": "77c2764f-3d24-48db-aef2-07b64e9ecdeb"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "059b3d30-905f-4038-b8c1-9582bae19867",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "91d4813d-55f8-40af-a588-cc77a7b30153",
              "leftValue": "= {{ $('Usuario').item.json.password }}",
              "rightValue": "={{ $json.senha_hash }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1744,
        -480
      ],
      "id": "8a80f3dd-39f6-4023-a449-34c1f5b08415",
      "name": "If2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1120,
        -496
      ],
      "id": "ddacec62-efaf-4792-b468-8005220f3e29",
      "name": "Merge2"
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -624,
        -496
      ],
      "id": "19da1092-7db7-4d4d-8e83-ed8b51a74d0b",
      "name": "Respond to Webhook12"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "807e4143-d55c-420c-b026-90bb242e057f",
              "name": "email",
              "value": "={{ $json.body.email }}",
              "type": "string"
            },
            {
              "id": "f3078e1c-88ef-46e0-8681-76c60898ac50",
              "name": "senha",
              "value": "={{ $json.body.senha}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2496,
        -480
      ],
      "id": "4713b606-8183-4b3c-aa53-e46ee4f62cc9",
      "name": "Usuario"
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -1904,
        -128
      ],
      "id": "060be98f-3047-4bfa-acb2-fb72db53ef67",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f3078e1c-88ef-46e0-8681-76c60898ac50",
              "name": "empresa_id",
              "value": "={{ $json.body.empresa_id}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2496,
        -128
      ],
      "id": "17fddb20-03e3-4e99-8bcf-366d9244940f",
      "name": "EditPerfil_usario"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": " select codigo from empresa_perfil as  e \n   inner join perfis  as p on     p.id = e.perfil_id WHERE empresa_id = {{ $json.empresa_id }} and p.ativo = true",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2208,
        -128
      ],
      "id": "9e6c25ed-0697-4289-8724-8c5813cc71bd",
      "name": "QueryPerfilSidebar",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "perfil",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2704,
        -128
      ],
      "id": "7c0bdcda-3946-4b0a-addf-e7565eb3fa9c",
      "name": "Menu",
      "webhookId": "77c2764f-3d24-48db-aef2-07b64e9ecdeb"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "usuarios",
        "filters": {
          "conditions": [
            {
              "keyName": "email",
              "keyValue": "={{$json.email}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        544,
        -368
      ],
      "id": "859a08d3-41a2-4a1e-b301-a9643bcf0eb6",
      "name": "DadosUsuario1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "GfCFzcpZSxkxWy1M",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "059b3d30-905f-4038-b8c1-9582bae19867",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        768,
        -368
      ],
      "id": "3e00477b-5c68-4c74-83d1-47df8c16b9d1",
      "name": "If"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "807e4143-d55c-420c-b026-90bb242e057f",
              "name": "email",
              "value": "={{ $json.body.email }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        304,
        -368
      ],
      "id": "7977c0a2-07cf-4b77-8715-12029a79cbb4",
      "name": "Usuario1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "esqueci_senha",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        96,
        -368
      ],
      "id": "a23d3c49-47c6-4e1d-8fc0-5a12aebf40ee",
      "name": "EsqueciSenha",
      "webhookId": "77c2764f-3d24-48db-aef2-07b64e9ecdeb"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select * from gerar_token_recuperacao('{{ $json.email }}');\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1024,
        -608
      ],
      "id": "5dcc945d-c810-403e-adb7-817bf4ebbf9e",
      "name": "RecuperaSenha",
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select\n  r.token,\n  u.email,*\nfrom recuperacao_senha r\njoin public.usuarios u on u.id = r.usuario_id\n  where u.email = '{{ $('Usuario1').item.json.email }}'\n  and r.usado = false\n   AND r.expira_em > now()\norder by r.criado_em desc\nlimit 1;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1216,
        -608
      ],
      "id": "747e6cf3-8923-4a9d-b515-cfdcea661e8f",
      "name": "RetornaToken",
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "jsCode": " const token =$input.first().json.token; \n\nconst link = `https://finance-flow-woad-xi.vercel.app/redefinir-senha?token=${token}`;\n\nreturn [{\n  json: {\n    email: $input.first().json.email ,\n    link\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1424,
        -608
      ],
      "id": "5f8d3ac0-c906-4b16-b886-1ae17d864e6c",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "fromEmail": "lglducci@lglducciautomacoesia.me",
        "toEmail": "={{ $json.email }}",
        "subject": "Recupera√ß√£o de senha ‚Äì Finance Flow",
        "html": "=<div style=\"font-family: Arial, sans-serif; font-size:14px\">\n  <p>Ol√°,</p>\n\n  <p>Recebemos uma solicita√ß√£o para redefinir sua senha.</p>\n\n  <p>\n    <a href=\"{{ $json.link }}\"\n       style=\"background:#2563eb;color:#fff;padding:10px 16px;\n              border-radius:6px;text-decoration:none;\">\n      Redefinir senha\n    </a>\n  </p>\n\n  <p>Ou copie e cole no navegador:</p>\n  <p>{{ $json.link }}</p>\n\n  <p>Este link expira em 1 hora.</p>\n\n  <p>Se voc√™ n√£o solicitou, ignore este e-mail.</p>\n\n  <hr/>\n  <small>Finance-Flow</small>\n</div>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        1632,
        -608
      ],
      "id": "b5f47945-caea-4fae-b9c7-feba0021a103",
      "name": "Send email",
      "webhookId": "8b95b66e-abfc-43fd-9e1b-bed12c8da574",
      "credentials": {
        "smtp": {
          "id": "9MsZAm8XS8R1UHqM",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1872,
        -368
      ],
      "id": "d98e6640-7dbe-4b8f-8be5-2c8efa6d6886",
      "name": "Respond to Webhook13"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "807e4143-d55c-420c-b026-90bb242e057f",
              "name": "token",
              "value": "={{ $json.body.token }}",
              "type": "string"
            },
            {
              "id": "d5a8cbc0-68ec-4e6e-b259-2311d2246733",
              "name": "senha",
              "value": "={{ $json.body.senha }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        336,
        -144
      ],
      "id": "18a27da9-3506-442c-8994-999e42515b7f",
      "name": "UsarioSenha"
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1040,
        -144
      ],
      "id": "5077f2dc-fecd-42a4-a054-d82dc3e5bbe3",
      "name": "Respond to Webhook14"
    },
    {
      "parameters": {
        "jsCode": " const crypto = require(\"crypto\");\n$input.first().json.senha\nconst senha = $input.first().json.senha  || $input.first().json.senha  || \"\";\nconst hash = crypto.createHash(\"sha256\").update(senha, \"utf8\").digest(\"hex\");\n\nreturn [{\n  ...$json,\n  senha_hash: hash\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        -144
      ],
      "id": "2713de2b-294f-4697-a77f-c2f1c42ba482",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "jsCode": " const crypto = require(\"crypto\");\n$input.first().json.senha\nconst senha = $input.first().json.senha  || $input.first().json.senha  || \"\";\nconst hash = crypto.createHash(\"sha256\").update(senha, \"utf8\").digest(\"hex\");\n\nreturn [{\n  ...$json,\n  senha_hash: hash\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2240,
        -480
      ],
      "id": "e030d0bd-f1d2-49dc-848c-cc30a58210ea",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "dados_sessao",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        128,
        96
      ],
      "id": "25a842b1-1782-4e1a-9bcd-5f9358fad443",
      "name": "Dados Sess√£o",
      "webhookId": "77c2764f-3d24-48db-aef2-07b64e9ecdeb"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f3078e1c-88ef-46e0-8681-76c60898ac50",
              "name": "empresa_id",
              "value": "={{ $json.body.empresa_id}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        368,
        96
      ],
      "id": "93b3fddd-6759-40e1-bb45-96926cf4c825",
      "name": "EditSessao"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select u.nome nome, e.tipo, e.nome nome_empresa, e.documento , email from empresas\nas e inner join usuario_empresa ue on ue.empresa_id = e.id inner join usuarios u on u.id = ue.usuario_id  where e.id = {{ $json.empresa_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        576,
        96
      ],
      "id": "e66765e6-5383-4bfa-9e52-06edade9883c",
      "name": "Execute a SQL query1",
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        800,
        96
      ],
      "id": "90a11e83-cf49-47ba-8539-8898b41cc3b6",
      "name": "Respond to Webhook15"
    },
    {
      "parameters": {
        "content": "##Login \n**Fluxo de login no sistema e permissoes no sistema",
        "height": 736,
        "width": 2480
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2832,
        -672
      ],
      "id": "a39b0600-13fa-4a20-add9-b94a5918065a",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "##Recuperaca de senha\n**  Fluxo de recuperacao de senhas , envio de senha para email",
        "height": 1264,
        "width": 2480,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -80,
        -720
      ],
      "id": "374818a9-cb04-44f0-9cb7-c699b46b27b3",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "redefinir_senha",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        128,
        -144
      ],
      "id": "06dc834d-a7ed-4bd2-92d2-123d9460998f",
      "name": "Redefinir Senha",
      "webhookId": "77c2764f-3d24-48db-aef2-07b64e9ecdeb"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select * from public.ff_redefinir_senha  ('{{ $json.token }}' ,'{{ $json.senha_hash }}') ;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        832,
        -144
      ],
      "id": "35ba2a16-90b1-42e4-8e22-75f9f4f5277a",
      "name": "ff_redefinir_senha",
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "content": "##Lembrete!!\n**Lembre de lana√ßamento no Sistema (tela ) e envido de email e Zap.",
        "height": 864,
        "width": 1520,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2960,
        176
      ],
      "id": "3669497f-e989-4cf9-878f-dce570bdcc15",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -1888,
        352
      ],
      "id": "287ff10b-a925-4dc6-8edf-06fef4be657d",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f3078e1c-88ef-46e0-8681-76c60898ac50",
              "name": "empresa_id",
              "value": "={{ $json.body.empresa_id}}",
              "type": "string"
            },
            {
              "id": "4dd957d7-e706-4012-af89-2d9525039b9c",
              "name": "data_ini",
              "value": "={{ $json.body.data_ini}}",
              "type": "string"
            },
            {
              "id": "b123247b-7996-4e83-ba0f-da07eddde515",
              "name": "data_fim",
              "value": "={{ $json.body.data_fim}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2416,
        352
      ],
      "id": "7a490440-1a2a-4a2c-906f-9358fb6d4040",
      "name": "EditPerfil_usario1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "lembrete",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2688,
        352
      ],
      "id": "f51b289f-9577-406f-a7a5-d63d0d403d4e",
      "name": "Lembrete",
      "webhookId": "77c2764f-3d24-48db-aef2-07b64e9ecdeb"
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -1808,
        544
      ],
      "id": "6846ae6f-aadd-4b05-88de-7acb668c6f29",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f3078e1c-88ef-46e0-8681-76c60898ac50",
              "name": "empresa_id",
              "value": "={{ $json.body.empresa_id}}",
              "type": "string"
            },
            {
              "id": "b123247b-7996-4e83-ba0f-da07eddde515",
              "name": "ids",
              "value": "={{ $json.body.ids}}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2384,
        544
      ],
      "id": "9ed703b2-0426-4462-9f46-cdad87f64dc6",
      "name": "EditPerfil_usario2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": " WITH partidas AS (\n  SELECT\n    l.lote_id,\n    MAX(l.historico) AS historico,\n\n    MAX(CASE WHEN l.debito  > 0 THEN l.conta_id END) AS conta_debito_id,\n    SUM(COALESCE(l.debito, 0))                       AS debito,\n\n    MAX(CASE WHEN l.credito > 0 THEN l.conta_id END) AS conta_credito_id,\n    SUM(COALESCE(l.credito, 0))                      AS credito\n\n  FROM contab.lancamentos l\n  WHERE l.empresa_id = {{ $json.empresa_id }}\n  GROUP BY l.lote_id\n)\n\nSELECT\n  lb.id                AS lembrete_id,\n  lb.lote_id,\n  lb.descricao         AS lembrete_descricao,\n  lb.valor,\n  lb.data_vencimento,\n  lb.enviar_email,\n  lb.enviar_whatsapp,\n  lb.status,\n\n  -- Partida dobrada sintetizada\n  p.historico,\n\n  cd.codigo || ' || ' || cd.nome AS conta_debito,\n  p.debito,\n\n  cc.codigo || ' || ' || cc.nome AS conta_credito,\n  p.credito\n\nFROM contab.lembretes lb\n\nJOIN partidas p\n  ON p.lote_id = lb.lote_id        -- üîí V√çNCULO √öNICO E CORRETO\n\nLEFT JOIN contab.contas cd ON cd.id = p.conta_debito_id\nLEFT JOIN contab.contas cc ON cc.id = p.conta_credito_id\n\nWHERE lb.empresa_id = {{ $json.empresa_id }}\n  AND lb.status = 'PENDENTE'\n  AND lb.data_vencimento\n      BETWEEN '{{ $json.data_ini }}' AND '{{ $json.data_fim }}'\n\nORDER BY lb.data_vencimento DESC, lb.lote_id;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2192,
        352
      ],
      "id": "c96ed348-cbcc-4c9a-8606-dfb861080847",
      "name": "LembretesCtb",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": " UPDATE contab.lembretes\nSET status = 'BAIXADO',\n    baixado_em = NOW()\nWHERE id IN ({{ $json.ids }})\n  AND empresa_id = {{ $json.empresa_id }};\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2144,
        544
      ],
      "id": "3b72ced2-97ee-4fc1-9da5-3c07ad1d7a7f",
      "name": "AtualizaLembrete",
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "baixar_lembrete",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2672,
        544
      ],
      "id": "28e9aa67-a7a9-4bdc-9c47-024961cbb0ae",
      "name": "BaixarLembrete",
      "webhookId": "77c2764f-3d24-48db-aef2-07b64e9ecdeb"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": " WITH partidas AS (\n  SELECT l.empresa_id,\n    l.lote_id,\n    MAX(l.historico) AS historico,\n\n    MAX(CASE WHEN l.debito  > 0 THEN l.conta_id END) AS conta_debito_id,\n    SUM(COALESCE(l.debito, 0))                       AS debito,\n\n    MAX(CASE WHEN l.credito > 0 THEN l.conta_id END) AS conta_credito_id,\n    SUM(COALESCE(l.credito, 0))                      AS credito\n\n  FROM contab.lancamentos l\n \n  GROUP BY l.empresa_id , l.lote_id\n)\n\nSELECT lb.empresa_id, \n  lb.id                AS lembrete_id,\n  lb.lote_id,\n  lb.descricao         AS lembrete_descricao,\n  lb.valor,\n  to_char(lb.data_vencimento, 'DD-MM-YYYY') AS data_vencimento,\n  lb.enviar_email,\n  lb.enviar_whatsapp,\n  lb.status,\n\n  -- Partida dobrada sintetizada\n  p.historico,\n\n  cd.codigo || ' || ' || cd.nome AS conta_debito,\n  p.debito,\n\n  cc.codigo || ' || ' || cc.nome AS conta_credito,\n  p.credito\n\nFROM contab.lembretes lb\n\nJOIN partidas p\n  ON p.lote_id = lb.lote_id        -- üîí V√çNCULO √öNICO E CORRETO\n\nLEFT JOIN contab.contas cd ON cd.id = p.conta_debito_id\nLEFT JOIN contab.contas cc ON cc.id = p.conta_credito_id\n\nWHERE lb.empresa_id = 1\n  AND lb.status = 'PENDENTE'\n  AND lb.data_vencimento <= now() + interval '7 days'\n\n\nORDER BY  lb.empresa_id, lb.data_vencimento DESC, lb.lote_id;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2640,
        752
      ],
      "id": "3cc188ab-8447-498c-b0c0-1232139fbdbe",
      "name": "LembretesCtb2",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select u.nome, email ,  '{{ $json.lembrete_descricao }}' as descricao,  '{{ $json.data_vencimento }}' as vencimento  , '{{ $json.historico }}' as historico ,  '{{ $json.conta_debito }}' as debito , '{{ $json.conta_credito }}' as credito ,  {{ $json.credito }}  as valor from usuario_empresa as ue inner join usuarios as u on u.id =ue.usuario_id  \nwhere ue.empresa_id = {{ $json.empresa_id }}\n\nlimit 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2432,
        752
      ],
      "id": "f8d81522-8de4-4445-bd21-24c4b7da90ca",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "2CNjdfsJzrRLFqHu",
          "name": "FinanceFlow"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "lglducci@lglducciautomacoesia.me",
        "toEmail": "={{ $json.email }}",
        "subject": "Recupera√ß√£o de senha ‚Äì Finance Flow",
        "html": "= <div style=\"font-family: Arial, sans-serif; font-size:14px\">\n  <p>Ol√° {{ $json.nome }},</p>\n\n  <p>üìå Este √© um lembrete de vencimento de uma obriga√ß√£o cont√°bil:</p>\n\n  <table style=\"border-collapse: collapse; margin: 16px 0;\">\n    <tr>\n      <td style=\"padding: 4px 8px;\"><strong>Descri√ß√£o:</strong></td>\n      <td style=\"padding: 4px 8px;\">{{ $json.descricao }}</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 4px 8px;\"><strong>Vencimento:</strong></td>\n      <td style=\"padding: 4px 8px;\">{{ $json.vencimento }}</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 4px 8px;\"><strong>Hist√≥rico:</strong></td>\n      <td style=\"padding: 4px 8px;\">{{ $json.historico }}</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 4px 8px;\"><strong>D√©bito:</strong></td>\n      <td style=\"padding: 4px 8px;\">{{ $json.debito }}</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 4px 8px;\"><strong>Cr√©dito:</strong></td>\n      <td style=\"padding: 4px 8px;\">{{ $json.credito }}</td>\n    </tr>\n    <tr>\n      <td style=\"padding: 4px 8px;\"><strong>Valor:</strong></td>\n      <td style=\"padding: 4px 8px;\">R$ {{ $json.valor }}</td>\n    </tr>\n  </table>\n\n  <p style=\"margin-bottom: 16px;\">\n    Caso j√° tenha realizado esse pagamento, desconsidere este aviso.<br/>\n    Se n√£o, programe-se para evitar atrasos ou encargos.\n  </p>\n\n  <p style=\"margin-bottom: 16px;\">\n    Em caso de d√∫vidas ou diverg√™ncias, entre em contato com sua contabilidade.\n  </p>\n\n  <hr/>\n  <small>Finance-Flow ‚Ä¢ Sistema de Gest√£o Cont√°bil</small>\n</div>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -2208,
        752
      ],
      "id": "db9f7ce8-7e6e-4474-bddd-861e3fe2ee62",
      "name": "Send email1",
      "webhookId": "8b95b66e-abfc-43fd-9e1b-bed12c8da574",
      "credentials": {
        "smtp": {
          "id": "9MsZAm8XS8R1UHqM",
          "name": "SMTP account"
        }
      }
    }
  ],
  "pinData": {
    "Usuario1": [
      {
        "json": {
          "email": "lglducci@hotmail.com"
        }
      }
    ],
    "UsarioSenha": [
      {
        "json": {
          "token": "170c0b71-48ee-437f-a643-4fd5dc3ea92d",
          "senha": "aprumabatata"
        }
      }
    ],
    "EditPerfil_usario1": [
      {
        "json": {
          "empresa_id": 1,
          "data_ini": "20260101",
          "data_fim": "20260201"
        }
      }
    ]
  },
  "connections": {
    "Sim": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "N√£o": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "DadosUsuario": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DadosEmpresa": {
      "main": [
        [
          {
            "node": "Respond to Webhook12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Login": {
      "main": [
        [
          {
            "node": "Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Sim",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "N√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "DadosEmpresa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usuario": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EditPerfil_usario": {
      "main": [
        [
          {
            "node": "QueryPerfilSidebar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QueryPerfilSidebar": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Menu": {
      "main": [
        [
          {
            "node": "EditPerfil_usario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DadosUsuario1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "RecuperaSenha",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usuario1": {
      "main": [
        [
          {
            "node": "DadosUsuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EsqueciSenha": {
      "main": [
        [
          {
            "node": "Usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RecuperaSenha": {
      "main": [
        [
          {
            "node": "RetornaToken",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RetornaToken": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send email": {
      "main": [
        [
          {
            "node": "Respond to Webhook13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UsarioSenha": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "ff_redefinir_senha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "DadosUsuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados Sess√£o": {
      "main": [
        [
          {
            "node": "EditSessao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EditSessao": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Respond to Webhook15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redefinir Senha": {
      "main": [
        [
          {
            "node": "UsarioSenha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ff_redefinir_senha": {
      "main": [
        [
          {
            "node": "Respond to Webhook14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EditPerfil_usario1": {
      "main": [
        [
          {
            "node": "LembretesCtb",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lembrete": {
      "main": [
        [
          {
            "node": "EditPerfil_usario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EditPerfil_usario2": {
      "main": [
        [
          {
            "node": "AtualizaLembrete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LembretesCtb": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AtualizaLembrete": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BaixarLembrete": {
      "main": [
        [
          {
            "node": "EditPerfil_usario2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LembretesCtb2": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Send email1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "439530b0-9599-4b5d-93a1-f0dc1ceb04f3",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b3ad269e5ed8d3b4685167408bbbe03e6a154b6945c16284e8864807e278e62f"
  },
  "id": "KkQ8ZKfiQJIIeUQ3",
  "tags": []
}